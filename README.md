<!-- The TOC and section numberings are generated by VS Code extension "Markdown All in One" -->
- [1. Build Steps (MacOS)](#1-build-steps-macos)
- [2. Prerequisites for GCP](#2-prerequisites-for-gcp)
  - [2.1. Companion Assets](#21-companion-assets)
  - [2.2. GCP Credential](#22-gcp-credential)
  - [2.3. Choose a GCP Project as the Rapid Cloud Activation Project](#23-choose-a-gcp-project-as-the-rapid-cloud-activation-project)
  - [2.4. Target Environment Project(s): Enable GCP APIs](#24-target-environment-projects-enable-gcp-apis)
  - [2.5. Target Environment Project(s): Select Firestore Native Mode and Region](#25-target-environment-projects-select-firestore-native-mode-and-region)
- [3. Build Steps Windows](#3-build-steps-windows)
- [4. Troubleshooting](#4-troubleshooting)
  - [4.1. Troubleshooting A: `SSL: CERTIFICATE_VERIFY_FAILED`](#31-troubleshooting-a-ssl-certificate_verify_failed)
  - [4.2. Troubleshooting B: `Port 5000 is in use by another program`](#32-troubleshooting-b-port-5000-is-in-use-by-another-program)



# 1. Build Steps (MacOS)


```console
  ## Prompts to install each prerequisite such as Python interpreter, etc.
$ make configure

$ make install
```

# 2. Prerequisites for GCP

## 2.1. Companion Assets

  * The per-module repo: https://bitbucket.org/kinect-consulting/rc-gcp-lz


## 2.2. GCP Credential

RapidCloud authenticates to GCP in the order [explained here](https://cloud.google.com/docs/authentication/application-default-credentials#search_order), i.e.,

1. A (secret) key file (generated from a `Service Account`) referenced by the environment variable `GOOGLE_APPLICATION_CREDENTIALS`

2. Or: Credentials set up by the command `gcloud auth application-default login` (usually stored at `$HOME/.config/gcloud/application_default_credentials.json`). The command pops up a browser window for you to interactively sign in to GCP console where you'd enter an email address (i.e., the account) and password. This account must have the necessary permissions -- RapidCloud needs the project `Owner` IAM role.

3. Or: In the case of running on a GCP Compute Instance (i.e., VM) as opposed to your laptop, the `Service Account` attached to that VM.

For all above scenarios, the authenticated identity needs the project `Owner` IAM role.


## 2.3. Choose a GCP Project as the Rapid Cloud Activation Project

When activating Rapid Cloud (`./kc activate`), the "current credential/project" is found [in this order](https://cloud.google.com/docs/authentication/application-default-credentials#search_order).

Therefore, set up your terminal's environment so that the current credential/project is correct -- for example, it is your work credential/project (typically a user ID that is your work email address and a project ID that is your company's GCP project) rather than your personal credential (typically a user ID like `joe@hotmail.com`). We call this the Rapid Cloud **Activation Credential/Project**. Each time we launch Rapid Cloud from a shell (e.g., `./kc ...`), the shell must be configured so that it points to this (fixed) activation credential/project.

For example, the easiest method is to do the following:

  1. `gcloud config set project MY-RC-ACTIVATION-PROJECT`
  2. `gcloud auth application-default login`
  3. Each time we launch Rapid Cloud, ensure that `GOOGLE_APPLICATION_CREDENTIALS` is **unset**, e.g., (if necessary): `unset GOOGLE_APPLICATION_CREDENTIALS`


## 2.4. Target Environment Project(s): Enable GCP APIs

The RC **activation project** (`./kc activate`) doesn't need to enable any special GCP APIs (beyond the default set of APIs when creating a vanilla project via GCP console).

For each Rapid Cloud's **target environment project**, enable the following APIs in the (existing) target GCP project **before** doing `./kc init create-env`.

Either via the `gcloud` CLI:
```console
  ## This is necessary in order for Python to enable any other GCP APIs.
  ##    - https://bitbucket.org/kinect-consulting/kinect-theia-main/src/f45ad8de688846c36947754ca6a28482b73cd448/server/utils/gcp_metadata_utils.py#lines-141
  ##    - https://stackoverflow.com/questions/57526808/how-do-you-enable-gcp-apis-through-the-python-client-library/76047799#76047799
$ gcloud services enable serviceusage.googleapis.com  --project=YOUR-RAPID-CLOUD-TARGET-ENVIRONMENT-PROJECT-ID
```

or via the GCP Console (showing only 1 API as an exmple -- you'd need to repeat for all APIs above):

![](readme_pictures/Enable_Service_Usage_API.png)


## 2.5. Target Environment Project(s): Select Firestore Native Mode and Region

**Note:** According to [GCP docs here](https://cloud.google.com/firestore/docs/create-database-server-client-library#create_a_in_native_mode_database), there doesn't seem to be a Python API call to achieve what we want in this section. So, we have to:

  * either manually click buttons in GCP console as illustrated in the screenshot below;

  * or run the CLI [gcloud firestore databases create --type=firestore-native ...](https://cloud.google.com/sdk/gcloud/reference/firestore/databases/create) (which isn't what we are implementing at this time, but perhaps as a future enhancement).


In the GCP Console for each of the Rapid Cloud's **target environment project**, select the Firestore mode and region. Your selection here is permanent per project -- GCP doesn't allow you to change your mind per project. Rapid Cloud currently only supports Firestore `Native mode` (as opposed to `Datastore mode`):

![](readme_pictures/Select_Firestore_Mode_and_Region.png)


# 3. Build Steps windows

Install the latest version of Python3 on your windows system
python -m venv rcenv # Create a virtual environment with the name rcenv
rcenv/Scripts/activate  # this will activate the virtualenv
pip install -r requirements.txt # this will install the packages specified in requirements.txt using pip, if you see any error for any particular package you can comment it
pip install --upgrade botocore
pip install public-ip
pip install typing_extensions==4.4.0
pip install pyyaml

you might get an error for cx_Oracle pip package for that you have to install Visual studio build tools with customization and selecting c++ packages

once all the above packages are installed, run the below commands to setup rapid cloud

set below environment variables in windows power shell : 

$env:AZURE_SUBSCRIPTION_ID="0cea775f-c244-435a-a253-10f9f0f0fa26"
$env:AZURE_TENANT_ID="ce3603b3-94e8-40dd-ad3d-b38b894a71ee"
$env:AZURE_CLIENT_ID="9c095f7d-d8f9-4c8b-82ea-6111e7d5273c"
$env:AZURE_CLIENT_SECRET="Vq08Q~jmaG~ZXKnvmbv5l.CfH.dUGGUc7-jU4ac5"
$env:RAPIDCLOUD_AZURE_ENABLED="true"

Run : 
python ./kc activate   # you have to wait for Igor to activate your account

You can now create your RapidCloud environment by running following command:
python ./kc init create-env   # follow the prompts here to input required details

Or switch to an existing RapidCloud environment by running following command:
python ./kc init set-env --env [name_of_env]

Then start RapidCloud Console Server:
 python ./kc --no-browser

after running this you can access the rapidcloud UI on http://localhost:5000   

sign up with a new user on this page, and ping @igor to approve the request post which you will be able to login to the UI.

# 4. Troubleshooting

## 4.1. Troubleshooting A: `SSL: CERTIFICATE_VERIFY_FAILED`

Reference:
  * https://stackoverflow.com/questions/27835619/urllib-and-ssl-certificate-verify-failed-error

Error:

```text
$ ./kc

  ...
  File "/Users/vyin/.pyenv/versions/3.9.12/lib/python3.9/urllib/request.py", line 1389, in https_open
    return self.do_open(http.client.HTTPSConnection, req,
  File "/Users/vyin/.pyenv/versions/3.9.12/lib/python3.9/urllib/request.py", line 1349, in do_open
    raise URLError(err)
urllib.error.URLError: <urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1129)>
```

Solution: Run the `/Applications/Python 3.6/Install Certificates.command` which is installed by the MacOS installer for Python. However, if you didn't use MacOS installer to install Python, then that file doesn't exist. In that case, get the source code for that command here:
  * https://github.com/python/cpython/blob/main/Mac/BuildScript/resources/install_certificates.command

Extract the embedded Python script from the above file and run the resulting Python script directly on your Macbook like this:

```console
  ## On Macbook (Apple M1 chip for this example)

$ vi install_certifi.py  ## Create a new file and then paste in the embedded Python script from above.

$ chmod +x install_certifi.py


  ## Tip: I added this line to print some extra info message:
  ##      print(f"    relpath_to_certifi_cafile={relpath_to_certifi_cafile}\n    openssl_dir={openssl_dir}\n    openssl_cafile={openssl_cafile}")
$ ./install_certifi.py

  -- pip install --upgrade certifi
Collecting certifi
  Using cached certifi-2022.12.7-py3-none-any.whl (155 kB)
Installing collected packages: certifi
Successfully installed certifi-2022.12.7
 -- removing any existing file or link
 -- creating symlink to certifi certificate bundle
    relpath_to_certifi_cafile=../../../../Users/vyin/.pyenv/versions/3.9.12/lib/python3.9/site-packages/certifi/cacert.pem
    openssl_dir=/opt/homebrew/etc/openssl@1.1
    openssl_cafile=cert.pem
 -- setting permissions
 -- update complete


   ## Verify
$ ls -l /opt/homebrew/etc/openssl@1.1

lrwxr-xr-x  1 vyin  admin     92 Apr 10 15:09 cert.pem -> ../../../../Users/vyin/.pyenv/versions/3.9.12/lib/python3.9/site-packages/certifi/cacert.pem
...
```


## 4.2. Troubleshooting B: `Port 5000 is in use by another program`

Reference:
  * https://developer.apple.com/forums/thread/682332

Error:

```console
$ ./kc

Verifying aws account access (default, us-east-1) arn:aws:iam::xxxxxxxxxxxx:user/xxxx: ok

Starting RapidCloud Console ...
 - Default port is 5000.
 ...
 ...
Address already in use
Port 5000 is in use by another program. Either identify and stop that program, or start the server with a different port.
On macOS, try disabling the 'AirPlay Receiver' service from System Preferences -> Sharing.
```

As the last line above suggested, the Apple AirPlay is listening on port 5000 as can be seen below:

```console
$ lsof -nP +c 15 | grep LISTEN | grep 5000
ControlCenter    ...    IPv4    ...    TCP *:5000 (LISTEN)
ControlCenter    ...    IPv6    ...    TCP *:5000 (LISTEN)
```

Turn it off like this:

![](readme_pictures/AirPlay_Receiver_off.png)

